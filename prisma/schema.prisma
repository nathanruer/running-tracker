generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_DATABASE_URL")
}

model users {
  id                   String                @id @default(cuid())
  email                String                @unique
  password             String
  createdAt            DateTime              @default(now())
  conversations        conversations[]
  plan_sessions        plan_sessions[]
  workouts             workouts[]
  profile              user_profiles?
  preferences          user_preferences?
  externalAccounts     external_accounts[]
  externalActivities   external_activities[]
}

model user_profiles {
  id           String   @id @default(cuid())
  userId       String   @unique
  age          Int?
  maxHeartRate Int?
  weight       Float?
  vma          Float?
  goal         String?  @db.Text
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  user         users    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model user_preferences {
  id            String   @id @default(cuid())
  userId        String   @unique
  locale        String?
  units         String?
  timezone      String?
  notifications Json?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  user          users    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model external_accounts {
  id             String   @id @default(cuid())
  userId         String
  provider       String
  externalId     String
  accessToken    String?
  refreshToken   String?
  tokenExpiresAt DateTime?
  scopes         String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  user           users    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@unique([userId, provider])
  @@unique([provider, externalId])
}

model conversations {
  id                 String                   @id @default(cuid())
  title              String
  userId             String
  createdAt          DateTime                 @default(now())
  updatedAt          DateTime                 @updatedAt

  users              users                    @relation(fields: [userId], references: [id], onDelete: Cascade)
  conversation_messages conversation_messages[]

  @@index([userId])
  @@index([updatedAt])
  @@index([userId, updatedAt])
}

model conversation_messages {
  id                 String                          @id @default(cuid())
  conversationId     String
  role               String
  content            String                          @db.Text
  model              String?
  createdAt          DateTime                        @default(now())

  conversations      conversations                   @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  conversation_message_payloads conversation_message_payloads[]

  @@index([conversationId])
  @@index([conversationId, createdAt])
}

model conversation_message_payloads {
  id             String   @id @default(cuid())
  messageId      String
  payloadType    String
  payloadVersion String?
  payload        Json
  createdAt      DateTime @default(now())

  conversation_messages conversation_messages @relation(fields: [messageId], references: [id], onDelete: Cascade)

  @@index([messageId])
  @@unique([messageId, payloadType])
}

model plan_sessions {
  id                String   @id @default(cuid())
  userId            String
  sessionNumber     Int?
  week              Int?
  plannedDate       DateTime?
  sessionType       String?
  status            String   @default("planned")
  targetDuration    Int?
  targetDistance    Float?
  targetPace        String?
  targetHeartRateBpm String?
  targetRPE         Int?
  intervalDetails   Json?
  recommendationId  String?
  comments          String   @default("")
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  users             users    @relation(fields: [userId], references: [id], onDelete: Cascade)
  workouts          workouts[]

  @@index([userId])
  @@index([userId, plannedDate])
  @@index([status])
}

model workouts {
  id               String   @id @default(cuid())
  userId           String
  planSessionId    String?  @unique
  date             DateTime
  status           String   @default("completed")
  sessionNumber    Int?
  week             Int?
  sessionType      String?
  comments         String   @default("")
  perceivedExertion Int?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  users            users    @relation(fields: [userId], references: [id], onDelete: Cascade)
  plan_sessions    plan_sessions? @relation(fields: [planSessionId], references: [id], onDelete: SetNull)
  workout_metrics_raw      workout_metrics_raw?
  workout_metrics_derived  workout_metrics_derived?
  workout_streams          workout_streams[]
  external_activities      external_activities[]
  weather_observations     weather_observations?

  @@index([userId])
  @@index([userId, date])
  @@index([status])
}

model workout_metrics_raw {
  id              String   @id @default(cuid())
  workoutId       String   @unique
  durationSeconds Int?
  distanceMeters  Float?
  avgPace         String?
  avgHeartRate    Int?
  maxHeartRate    Int?
  averageCadence  Float?
  elevationGain   Float?
  calories        Int?

  workouts        workouts @relation(fields: [workoutId], references: [id], onDelete: Cascade)
}

model workout_metrics_derived {
  id              String   @id @default(cuid())
  workoutId       String   @unique
  pace            String?
  zones           Json?
  efficiency      Float?
  trainingLoad    Float?

  workouts        workouts @relation(fields: [workoutId], references: [id], onDelete: Cascade)
}

model external_activities {
  id             String   @id @default(cuid())
  workoutId      String
  userId         String
  source         String
  externalId     String
  sourceStatus   String?  @default("imported")
  startedAt      DateTime?
  elapsedSeconds Int?
  movingSeconds  Int?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  workouts       workouts @relation(fields: [workoutId], references: [id], onDelete: Cascade)
  user           users    @relation(fields: [userId], references: [id], onDelete: Cascade)
  external_payloads external_payloads?

  @@unique([userId, source, externalId])
  @@index([workoutId])
  @@index([userId, source])
}

model external_payloads {
  id                 String   @id @default(cuid())
  externalActivityId String   @unique
  payload            Json
  payloadType        String?
  payloadVersion     String?
  createdAt          DateTime @default(now())

  external_activities external_activities @relation(fields: [externalActivityId], references: [id], onDelete: Cascade)
}

model workout_streams {
  id            String   @id @default(cuid())
  workoutId     String
  streamType    String
  resolution    String?
  seriesType    String?
  originalSize  Int?
  createdAt     DateTime @default(now())

  workouts      workouts @relation(fields: [workoutId], references: [id], onDelete: Cascade)
  workout_stream_chunks workout_stream_chunks[]

  @@index([workoutId])
  @@index([workoutId, streamType])
}

model workout_stream_chunks {
  id             String   @id @default(cuid())
  workoutStreamId String
  chunkIndex     Int
  data           Json
  createdAt      DateTime @default(now())

  workout_streams workout_streams @relation(fields: [workoutStreamId], references: [id], onDelete: Cascade)

  @@index([workoutStreamId, chunkIndex])
}

model weather_observations {
  id                 String   @id @default(cuid())
  workoutId          String   @unique
  observedAt         DateTime?
  temperature        Float?
  apparentTemperature Float?
  humidity           Float?
  windSpeed          Float?
  precipitation      Float?
  conditionCode      Int?
  source             String?
  payload            Json?
  createdAt          DateTime @default(now())

  workouts           workouts @relation(fields: [workoutId], references: [id], onDelete: Cascade)
}
